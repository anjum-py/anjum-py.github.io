<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1 name=viewport><link href=http://localhost/projects/geolocation/ rel=canonical><title>
    Geolocation API
  </title><link crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/fontawesome.min.css integrity=sha512-SgaqKKxJDQ/tAUAAXzvxZz33rmn7leYDYfBP+YoMRSENhf3zJyx3SBASt/OfeQwBHA1nxMis7mM3EV/oYT6Fdw== referrerpolicy=no-referrer rel=stylesheet><link crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/brands.min.css integrity=sha512-9YHSK59/rjvhtDcY/b+4rdnl0V4LPDWdkKceBl8ZLF5TB6745ml1AfluEU6dFWqwDw9lPvnauxFgpKvJqp7jiQ== referrerpolicy=no-referrer rel=stylesheet><link crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/solid.min.css integrity=sha512-yDUXOUWwbHH4ggxueDnC5vJv4tmfySpVdIcN1LksGZi8W8EVZv4uKGrQc0pVf66zS7LDhFJM7Zdeow1sw1/8Jw== referrerpolicy=no-referrer rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://fonts.googleapis.com/css2?family=Montserrat&family=Open+Sans&display=swap rel=stylesheet><link href=/static/css/tailwind.css rel=stylesheet><link href=/static/css/prism.css rel=stylesheet><script defer src=/static/js/turbo/turbo.js></script><script defer src=/static/js/stimulus/stimulus.js></script><script data-manual src=/static/js/prism/prism.js></script><body class="antialiased container h-full max-w-screen-2xl mx-auto overflow-hidden bg-slate-50"><div class="h-full w-full"><div class="absolute h-full w-full right-0 left-0"><div class="flex absolute h-full w-full"><div class="flex flex-col h-full items-center justify-center container lg:max-w-screen-lg lg:mt-20 mx-auto"><div class="flex relative h-full w-full"><div class="flex flex-col w-full lg:flex-row"><div><div class="flex flex-col p-4 lg:items-center lg:space-y-4 lg:pt-10 mb-6 lg:px-16"><div class="w-16 h-16"><svg viewbox="0 0 182 182"fill=none xmlns=http://www.w3.org/2000/svg><path class="fill-slate-700 stroke-none"d="M122.5 81.32v36.45c0 1.9.4 3.55 1.23 4.94l.01.02.01.01a15.75 15.75 0 0 0 3.23 3.43l.03.02.02.01c1.34.8 2.75 1.41 4.23 1.81a19 19 0 0 0 10.22-.2h.03c2-.66 3.79-1.53 5.4-2.6l.02-.01c1.6-1.2 2.94-2.62 4.02-4.23v-.01a10.75 10.75 0 0 0 1.64-5.73v-.5h-.5c-1.36 0-2.66.27-3.9.81-1.06.4-2.12.93-3.18 1.6a81.68 81.68 0 0 1-3.26 1.53c-.97.36-2.14.55-3.52.55-2.96 0-5.05-.45-6.37-1.28-1.08-.77-1.73-2.49-1.73-5.45 0-5.58.33-11.03.98-16.34.65-5.5.98-11.05.98-16.67 0-.89.06-1.97.19-3.27.13-1.34.07-2.62-.2-3.84A5.45 5.45 0 0 0 130.6 69c-.77-1.05-1.98-1.54-3.5-1.54-.31 0-.8.07-1.42.2-.53 0-1 .07-1.35.24l-.03.02-.02.02a35.76 35.76 0 0 0-9.11 8.71l-.01.01c-2.35 3.4-4.58 7-6.67 10.78a854.23 854.23 0 0 0-6.25 11.14v.01a51.43 51.43 0 0 1-6.1 9.22v-.2c0-5.06.33-9.98.98-14.78.65-4.84.98-9.74.98-14.71 0-1.42.07-3.17.2-5.25.13-2.24 0-4.36-.4-6.36a10.19 10.19 0 0 0-2.05-5.1c-1.16-1.6-3.03-2.35-5.47-2.35-1.46 0-3.12.72-4.97 2.04a32.31 32.31 0 0 0-5.35 4.36 150.15 150.15 0 0 0-4.5 4.7c-1.31 1.44-2.15 2.34-2.53 2.72l-.02.02-.02.02c-.52.65-1.42 1.75-2.73 3.31-1.3 1.57-2.68 3.34-4.11 5.3-1.43 1.81-2.8 3.57-4.1 5.26-.65.78-1.2 1.46-1.62 2.02.02-1.3.08-2.97.17-5 .13-3.16-.06-6.26-.59-9.28-.4-3.17-1.26-5.9-2.6-8.18a6.96 6.96 0 0 0-2.4-2.81c-1.01-.65-2.18-.96-3.5-.96-1.56 0-3.4.63-5.52 1.82a54.88 54.88 0 0 0-6.7 4.53 69.74 69.74 0 0 0-6.89 6.1 133.7 133.7 0 0 0-6.07 6.47c-1.83 2.1-3.28 4-4.34 5.72-.6.85-1.05 1.6-1.35 2.26-.3.64-.5 1.22-.5 1.72v.78c0 .18.08.32.12.39a8.76 8.76 0 0 0 .81.95l.98.97.04.04.04.02c.4.27 1.07.67 1.98 1.2h.03c.4.2.74.35 1.01.43.13.04.28.07.42.07.13 0 .34-.03.51-.2L46.34 75.6l2.89-1.6 1.58 6.34v.52c0 4.54-.2 9.02-.58 13.43-.4 4.3-.85 8.65-1.37 13.08-.52 4.3-.97 8.6-1.37 12.9-.39 4.31-.58 8.69-.58 13.13v.5h.5c2.13 0 3.82-.4 4.98-1.27 1.16-.87 2.05-2.4 2.7-4.51.42-.85 1.08-2.77 1.97-5.7v-.01c.92-3.12 1.9-6.37 2.93-9.76 1.17-3.5 2.21-6.76 3.13-9.76a70.5 70.5 0 0 1 2.05-5.46l.01-.01.2-.18.52-.57c.43-.5 1.04-1.24 1.82-2.21a1595.26 1595.26 0 0 1 12.5-15.43c2.34-2.87 4.23-5.21 5.67-7.04l.03-.04.02-.04c.1-.2.3-.47.69-.85a4.41 4.41 0 0 1 .5-.44c.14 0 .3-.03.44-.1l.14-.1h.14l.14-.14a.35.35 0 0 1 .06-.05c.44 0 .8.21 1.12.73v.02l.02.03c.34.44.57 1.01.7 1.73v.05l.02.05c.23.59.36 1.24.36 1.97V76.56a75 75 0 0 1-.59 9.32c-.39 3.12-.84 6.3-1.36 9.55-.52 3.13-.98 6.26-1.37 9.4a76 76 0 0 0-.6 9.43V117.19c0 1.45.08 3.02.2 4.73v.02l.01.02c.27 1.6.74 3.09 1.41 4.44.36.72.84 1.28 1.46 1.66.6.39 1.32.57 2.12.57 1.67 0 3.36-1.2 5.07-3.31l.01-.01a78.39 78.39 0 0 0 5.31-8.06c1.83-3.14 3.66-6.67 5.49-10.58 1.95-3.9 3.83-7.6 5.65-11.12 1.95-3.5 3.77-6.62 5.45-9.34 1.47-2.2 2.8-3.82 3.96-4.88Z"/><circle class="stroke-slate-900 stroke-2"cx=91 cy=91 r=90.5 /></svg></div><div class="inline-flex flex-row space-x-4 lg:flex-col lg:space-x-0 lg:space-y-2"><a class="text-md font-semibold"href=/>home</a><a class="text-md font-semibold"href=/about/>about</a><a class="text-md font-semibold"href=/projects/>projects</a><a class="text-md font-semibold"href=/notes/>notes</a></div></div></div><div class="overflow-auto scroll-smooth flex flex-col lg:max-w-[800px] pb-20"><div class="p-2 max-w-[65ch]"><div><h1 class="lg:text-6xl text-5xl font-bold py-6">Geolocation API</h1><hr><div class="flex justify-between flex-wrap"><div><p class="text-sm text-slate-400">Published - 2023-06-07<p class="text-sm text-slate-400">Updated - 2023-06-08</div><div class="flex items-center space-x-4"><div><a class="inline-flex items-center space-x-1 text-slate-500"href=https://github.com/anjum-py/geolocation> <i class="fa-brands fa-github text-lg"></i> <span class=text-base>GitHub</span> </a></div><div><a class="inline-flex items-center space-x-1 text-slate-500"href=https://geolocation-api-zuravksy3a-el.a.run.app/docs> <i class="fa-solid fa-circle-nodes text-lg"></i> <span class=text-base>OpenAPI</span> </a></div></div></div></div><div class="flex flex-col space-y-4 my-10 flex-auto"><div class=block-h2><h2 class=text-2xl id=about-this-project>About this project</h2></div><div class=block-richtext><div class=prose><p data-block-key=yoe21>In this portfolio project, I built an API that looks up IP addresses from MaxMind GeoLite2 databases. This API is powered by FastAPI and MaxMind GeoLite2 databases and provides one endpoint. If the request includes a <code>POST</code> body with <code>ip_address,</code> the endpoint will look up the requested IP address or the endpoint will lookup the origin IP address of the request as long as this public IP address is in MaxMind databases.<p data-block-key=8gb68>The main focus of this project was to learn and understand the intricacies involved in automated deployment of a microservice to Google Cloud's managed, serverless containers platform, Cloud Run. I used Cloud Development Kit for Terraform (CDKTF) to automate deployment of the required infrastructure components to secure and run our microservice.<p data-block-key=3o65c>On this page I have made an attempt to explain how various tools and technologies are used to build and deploy this project. Your feedback, suggestions, and questions are very valuable to me. Please do not hesitate to share your views.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=demo>Demo</h2></div><div class=block-html><div><div class="flex flex-col space-y-4"data-controller=geolocation><input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500"placeholder="Enter IP address"data-geolocation-target=input><button class="shadow bg-purple-500 hover:bg-purple-400 focus:shadow-outline focus:outline-none text-white font-bold py-2 px-4 rounded"data-action="click->geolocation#fetchData"type=button>Look up IPv4 or IPv6</button><p data-geolocation-target=ipAddress><pre><code class=language-json data-geolocation-target=dataHolder></code></pre></div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=what-problems-does-this-project-solve>What problems does this project solve?</h2></div><div class=block-richtext><div class=prose><p data-block-key=gvpgx>The API looks up the visitor's IP address and use MaxMind GeoLite2 City databases to return data about the visitor's location. You can learn more about the databases <a href=https://dev.maxmind.com/geoip>here.</a><p data-block-key=qq3d>Geolocation data can be used to customize the user experience, target marketing, detect fraud, improve security, and comply with regulations.<p data-block-key=oo78>I have used the geolocation data with the <a href=https://intl-tel-input.com/examples/lookup-country.html>International Telephone Input</a> library to enhance the user experience by formatting international phone numbers.<p data-block-key=33cg8>However, the main intention behind this project is to build something small but useful for my portfolio that showcases my ability to automate building, testing, and deploying highly scalable serverless cloud native applications to Google Cloud Platform.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=how-to-build-and-deploy>How to build and deploy</h2></div><div class=block-h3><h3 class=text-xl id=overview>Overview</h3></div><div class=block-richtext><div class=prose><p data-block-key=79b2b>The project requires a container image as its basic component. The Dockerfile in the project root uses a multi-stage build to create a lightweight image. This image downloads updated MaxMind GeoLite2 databases and includes them. Once we have the image, we can deploy it to any platform that supports containerized services. In this case, I will explain how to deploy it to Google Cloud Platform's Cloud Run using Cloud Development Kit for Terraform (CDKTF). We will be using Google Cloud's Cloud Shell for initial setup of required cloud resources.<p data-block-key=as67n>To ensure separation of environment configuration data, we will utilize environment variables.<p data-block-key=30sig>CDKTF will handle the deployment of all necessary components on Google Cloud.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=create-google-cloud-account>Create Google Cloud Account</h2></div><div class=block-richtext><div class=prose><p data-block-key=6nqlj>Create a new Google account or use your existing one to login to <a href=http://console.cloud.google.com>GCP console</a>. Most of the components require a project with billing enabled.</div></div><div class=block-warning><div class="inline-flex bg-red-200 p-4 space-x-4 w-full"><div><i class="fa-solid fa-circle-exclamation text-xl text-red-800"></i></div><div class=prose><p data-block-key=6o36g>Before we move forward, just a word of caution. Most of the Google Cloud components that we require to set up need a functional billing account. Please be advised that you might incur charges for the services deployed in your Google Cloud account.</div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=create-a-project-in-google-cloud>Create a project in Google Cloud</h2></div><div class=block-richtext><div class=prose><p data-block-key=i4e49>We need an existing Google Cloud project to deploy our Geolocation service. Follow this <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project>guide to create project</a>. You can choose any name of your project, but the project ID has to be unique globally.</div></div><div class=block-alert><div class="inline-flex bg-amber-200 p-4 space-x-4 w-full"><div><i class="fa-solid fa-bell text-xl text-amber-800"></i></div><div class=prose><p data-block-key=ivl6n>Make a note of the project name and project id. We will have to add these to our <code>.env</code> file.</div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=create-a-service-account>Create a service account</h2></div><div class=block-richtext><div class=prose><p data-block-key=33vvb>We will also need a service account with <code>roles/editor</code> role to apply our CDKTF configuration. You will have to download and save the credentials in <code>json</code> format to use with CDKTF.<ol><li data-block-key=8fff2>To create a service account, <a href=https://cloud.google.com/iam/docs/service-accounts-create>follow this guide</a>.<li data-block-key=2mrmn>To get service account credentials, <a href=https://cloud.google.com/iam/docs/keys-list-get#iam-service-account-keys-list-gcloud>follow this guide</a>.</ol><p data-block-key=2se77>Once you have downloaded the credentials to your local machine, you will have to upload the key file to Cloud Shell environment to make sure it is available to CDKTF.</div></div><div class=block-alert><div class="inline-flex bg-amber-200 p-4 space-x-4 w-full"><div><i class="fa-solid fa-bell text-xl text-amber-800"></i></div><div class=prose><p data-block-key=hlnvf>Make a note of the absolute path of the key file in your Cloud Shell environment. We will have to add this path to our <code>.env</code> file.</div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=fork-the-git-repository>Fork the git repository</h2></div><div class=block-richtext><div class=prose><p data-block-key=0unsp>We will have to connect the git repository to our Cloud Build trigger, but Cloud Build does not allow us to connect to repositories from any other GitHub account, even if the repository is public. We can only connect to repositories in our own GitHub account. For this reason, you will have to fork <a href=https://github.com/anjum-py/geolocation>this git repository</a> to be able to access it from your GitHub account.</div></div><div class=block-alert><div class="inline-flex bg-amber-200 p-4 space-x-4 w-full"><div><i class="fa-solid fa-bell text-xl text-amber-800"></i></div><div class=prose><p data-block-key=ivl6n>Make a note of the of url of the forked git repository. We will need to add this to our <code>.env</code> file</div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=connect-git-repository>Connect git repository</h2></div><div class=block-richtext><div class=prose><p data-block-key=ly2ld>Go ahead and connect the forked git repository in your GitHub account to Cloud Build Repositories by following <a href=https://cloud.google.com/build/docs/automating-builds/github/connect-repo-github?generation=1st-gen#connecting_a_github_repository>this guide</a>.<p data-block-key=3p8nn>Do not create a trigger yet. We will by using CDKTF to create a trigger.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=create-a-maxmind-developer-account>Create a MaxMind Developer Account</h2></div><div class=block-richtext><div class=prose><p data-block-key=33vvb>You will need to sign up for a free MaxMind Developer account for yourself to download and update the GeoLite2 databases. You can do this using the links provided <a href=https://dev.maxmind.com/geoip/geolite2-free-geolocation-data>on this page</a>.<p data-block-key=b9333>Once you have the account created, generate a license key and make a note of account ID.</div></div><div class=block-alert><div class="inline-flex bg-amber-200 p-4 space-x-4 w-full"><div><i class="fa-solid fa-bell text-xl text-amber-800"></i></div><div class=prose><p data-block-key=qni7z>Make a note of MaxMind license key and account ID. We will have to add these to our <code>.env</code> file.</div></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=start-google-cloud-shell>Start Google Cloud Shell</h2></div><div class=block-richtext><div class=prose><p data-block-key=oo2r4>Login to <a href=https://console.cloud.google.com/>Google Cloud Console</a> and activate Cloud Shell, by clicking on the <code>Activate Cloud Shell</code> button in the menu bar.<p data-block-key=6rce><b>We will be using Cloud Shell to run all our commands.</b></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=clone-git-repository>Clone git repository</h2></div><div class=block-richtext><div class=prose><p data-block-key=an96k>Clone git repository and <code>cd</code> into that directory. We need to get the source for CDKTF to deploy our infrasctructure.</div></div><div class=block-code><div class=highlight><pre><span></span>git<span class=w> </span>clone<span class=w> </span>--depth<span class=w> </span><span class=m>1</span><span class=w> </span>https://github.com/anjum-py/geolocation.git
<span class=nb>cd</span><span class=w> </span>geolocation
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=update-environment-variables>Update environment variables</h2></div><div class=block-richtext><div class=prose><p data-block-key=lagp4>Once we have the requirements set up, we will have to start configuring our environment variables. Create <code>.env</code> file in the root of cloned git repository. Copy and paste the content from the template below and update the required values.</div></div><div class=block-code><div class=highlight><pre><span></span><span class=c1># Google Cloud project name</span>
<span class=nv>PROJECT_NAME</span><span class=o>=</span>geolocation

<span class=c1># Few random alphanumeric characters to create unique names </span>
<span class=nv>RANDOM_ID</span><span class=o>=</span>1a363yu4

<span class=c1># Preferred Google Cloud region</span>
<span class=nv>REGION_PREFERRED</span><span class=o>=</span>asia-south1

<span class=c1># If your Google Project ID is not a combination of project name and random ID,</span>
<span class=c1># set the correct project ID</span>
<span class=nv>PROJECT_ID</span><span class=o>=</span><span class=si>${</span><span class=nv>PROJECT_NAME</span><span class=si>}</span>-<span class=si>${</span><span class=nv>RANDOM_ID</span><span class=si>}</span>

<span class=c1># You can update the following variables if required</span>
<span class=c1># else, they will be substituted based on the above values</span>
<span class=nv>BUCKET_PRIMARY_TF_STATE</span><span class=o>=</span>primary-tfstate-<span class=si>${</span><span class=nv>RANDOM_ID</span><span class=si>}</span>
<span class=c1># Make sure the name starts with 'env-config-'</span>
<span class=nv>BUCKET_ENV_CONFIG</span><span class=o>=</span>env-config-<span class=si>${</span><span class=nv>RANDOM_ID</span><span class=si>}</span>
<span class=nv>ARTIFACT_REPOSITORY_NAME</span><span class=o>=</span><span class=si>${</span><span class=nv>PROJECT_NAME</span><span class=si>}</span>
<span class=nv>CONTAINER_IMAGE_NAME</span><span class=o>=</span><span class=si>${</span><span class=nv>PROJECT_NAME</span><span class=si>}</span>
<span class=nv>CLOUDRUN_SERVICE_NAME</span><span class=o>=</span><span class=si>${</span><span class=nv>PROJECT_NAME</span><span class=si>}</span>-api
<span class=nv>CLOUDRUN_IMAGE</span><span class=o>=</span><span class=si>${</span><span class=nv>REGION_PREFERRED</span><span class=si>}</span>-docker.pkg.dev/<span class=si>${</span><span class=nv>PROJECT_ID</span><span class=si>}</span>/<span class=si>${</span><span class=nv>ARTIFACT_REPOSITORY_NAME</span><span class=si>}</span>/<span class=si>${</span><span class=nv>CONTAINER_IMAGE_NAME</span><span class=si>}</span>
<span class=nv>CLOUDRUN_IMAGE_LATEST</span><span class=o>=</span><span class=si>${</span><span class=nv>CLOUDRUN_IMAGE</span><span class=si>}</span>:latest

<span class=c1># Path of service account credentials file</span>
<span class=nv>SVAC_CREDENTIALS_PATH</span><span class=o>=</span>/path/of/credentials.json

<span class=c1># Space separated list of FastAPI CORS origins</span>
<span class=nv>FASTAPI_CORS_ORIGINS</span><span class=o>=</span><span class=s2>"https://cors-origin-domain.com"</span>

<span class=c1># Space separated list of FastAPI trusted hosts</span>
<span class=c1># "*" means allows all hosts</span>
<span class=c1># Ideally, this should be the url of our Cloud Run service</span>
<span class=c1># but that will be known only after applying our configuration </span>
<span class=nv>FASTAPI_ALLOWED_HOSTS</span><span class=o>=</span><span class=s2>"*"</span>

<span class=c1># url of forked repository</span>
<span class=nv>GIT_SOURCE_REPOSITORY</span><span class=o>=</span>https://github.com/<span class=s><&LTgithub_username>>/g</span>eolocation

<span class=c1># MaxMind Account details</span>
<span class=nv>GEOIPUPDATE_ACCOUNT_ID</span><span class=o>=</span><span class=m>000000</span>
<span class=nv>GEOIPUPDATE_LICENSE_KEY</span><span class=o>=</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

<span class=c1># Leave these unchanged</span>
<span class=nv>GEOIPUPDATE_EDITION_IDS</span><span class=o>=</span><span class=s2>"GeoLite2-ASN GeoLite2-City"</span>
<span class=nv>GEOIPUPDATE_DB_DIR</span><span class=o>=</span>/workspace/db
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=set-up-cdktf>Set up CDKTF</h2></div><div class=block-richtext><div class=prose><p data-block-key=jsbgk>Once we have our environment variables set, we can start deploying our CDKTF stacks, but before we do that, we need to make sure CDKTF is installed and providers are imported.</div></div><div class=block-h3><h3 class=text-xl id=install-cdktf>Install CDKTF</h3></div><div class=block-richtext><div class=prose><p data-block-key=1i7by>Activate Google Cloud Shell and install cdktf. You can follow the guide <a href=https://developer.hashicorp.com/terraform/tutorials/cdktf/cdktf-install>here</a> for more information regarding installing CDKTF.</div></div><div class=block-code><div class=highlight><pre><span></span>npm<span class=w> </span>install<span class=w> </span>--global<span class=w> </span>cdktf-cli@latest
</pre></div></div><div class=block-h3><h3 class=text-xl id=get-terraform-provider-code>Get terraform provider code</h3></div><div class=block-richtext><div class=prose><p data-block-key=1i7by>After CDKTF is installed, you will have to import the required provider code for it to work properly.</div></div><div class=block-code><div class=highlight><pre><span></span>cdktf<span class=w> </span>get
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=deploy-cdktf-basestack>Deploy CDKTF BaseStack</h2></div><div class=block-richtext><div class=prose><p data-block-key=iufju>Once we have CKDTF installed and environment variables configured, we can start deploying our infrastructure.<p data-block-key=1qd2a>CDKTF has this concept of stack, where a stack basically represents a set of defined resources for the cloud infrastructure.<p data-block-key=e8krf>In our deployment, I have separated the infrastructure in 3 separate stacks. The first stack is the base stack. In this stack, we will be enabling the required Google Cloud APIs and create a bucket to store our <code>.env</code> configuration file.<p data-block-key=hj4u>The reason to keep this base stack separate is that we do not want to disable these APIs before destroying resources. If we keep these as part of a stack that uses these APIs to create resources, at the time of destroying resources, the APIs would get disabled before the resources are destroyed. To avoid this race condition, I decided to keep this stack separate. Also, we do not want to destroy our <code>env-configuration</code> bucket accidentally as part of destroying other stack.</div></div><div class=block-code><div class=highlight><pre><span></span><span class=c1># check if cdktf plan works</span>
cdktf<span class=w> </span>plan<span class=w> </span>base

<span class=c1># deploy base stack</span>
<span class=c1># select approve when prompted</span>
cdktf<span class=w> </span>deploy<span class=w> </span>base
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=copy-env-file-to-env-config-bucket>Copy .env file to env-config bucket</h2></div><div class=block-richtext><div class=prose><p data-block-key=uagcd>Once we have the base stack applied, we will have enabled required APIs and created a bucket to store our <code>.env</code> file. This <code>.env</code> file will be accessible by Cloud Build pipeline which we will set up to automatically build, push, and deploy our Cloud Run service.</div></div><div class=block-code><div class=highlight><pre><span></span><span class=c1># make sure you are in project root</span>
<span class=c1># load the env file</span>
.<span class=w> </span>./.env

<span class=c1># copy .env file to cloud storage bucket</span>
gsutil<span class=w> </span>cp<span class=w> </span>.env<span class=w> </span>gs://<span class=nv>$BUCKET_ENV_CONFIG</span>/.env
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=deploy-pre-cloudrun-stack>Deploy pre-cloudrun stack</h2></div><div class=block-richtext><div class=prose><p data-block-key=iu1do>In this <code>pre-cloudrun</code> stack, we will be creating the following resources:<ol><li data-block-key=csgo8>A dedicated service account for Cloud Build pipeline<li data-block-key=4foae>Allow the Cloud Build service account access to Cloud Build<li data-block-key=7qcc4>Allow the Cloud Build service account to impersonate itself to use OAuth tokens for Cloud Scheduler job<li data-block-key=2gcf2>Create a docker container Artifact Registry<li data-block-key=3a56g>Set up a Cloud Build manual trigger<li data-block-key=3lj2f>Set up Google Cloud Scheduler weekly trigger for Cloud Build<li data-block-key=cobdh>Allow the Cloud Build service account to run Cloud Scheduler jobs</ol><p data-block-key=bhg11>Please feel free to examine the source code for more clarity.<p data-block-key=5kkd6>Apply the <code>pre-cloudrun</code> stack</div></div><div class=block-code><div class=highlight><pre><span></span><span class=c1># approve when prompted</span>

cdktf<span class=w> </span>deploy<span class=w> </span>pre-cloudrun
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=manually-trigger-the-cloud-build>Manually trigger the Cloud Build</h2></div><div class=block-richtext><div class=prose><p data-block-key=0elyx>For us to be able to deploy our Cloud Run service, we need the image to be available in Artifact Registry. To build and push the container image to Artifact Registry, go to the <a href=https://console.cloud.google.com/cloud-build/triggers>Cloud Build triggers page</a>, locate the <code>geolocation-trigger</code> trigger from the list, and click <code>RUN</code> to initiate the build pipeline.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=deploy-cloudrun-stack>Deploy cloudrun stack</h2></div><div class=block-richtext><div class=prose><p data-block-key=0bvew>Once we have the the container image uploaded to Artifact Registry, we can deploy our third and final stack. This stack applies the following resources to our GCP project:<ol><li data-block-key=cqcqg>Creates a dedicated service account with limited permissions.<li data-block-key=8pt3l>Creates a Cloud Run service revision using the image we build using Cloud Build.<li data-block-key=9vp3t>Attaches the service account to Cloud Run service.<li data-block-key=fc65>Updates the Cloud Run service to allow all unauthenticated users.<li data-block-key=cm3dn>Allows the Cloud Build service account to update and deploy the Cloud Run revisions.</ol></div></div><div class=block-code><div class=highlight><pre><span></span><span class=c1># approve when prompted</span>

cdktf<span class=w> </span>deploy<span class=w> </span>cloudrun
</pre></div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=deployment-complete>Deployment complete</h2></div><div class=block-richtext><div class=prose><p data-block-key=t2w7h>At this stage, we should have a running Cloud Run revision for our geolocation service. You can check the status of our deployed Cloud Run service <a href=https://console.cloud.google.com/run>here</a>. Click on the service link to open the Cloud Run page and access the url the service is hosted on.<p data-block-key=1vul8>Also, check for configured weekly schedule to trigger our Cloud Build <a href=https://console.cloud.google.com/cloudscheduler>here</a>. So, every week, our Cloud Build will get triggered and rebuild the image with updated MaxMind GeoLite2 databases and deploy the new Cloud Run revision.<p data-block-key=420me>It took quite a bit of work to reach here, but from now on, automation will take over. I have also added tests to the Cloud Build pipeline. If the tests fail, Cloud Build will stop the build pipeline on error and will not continue.</div></div><div class=block-gap><div class=h-[50px]></div></div><div class=block-h2><h2 class=text-2xl id=summary>Summary</h2></div><div class=block-richtext><div class=prose><p data-block-key=ifcna>I learnt the importance of automating application deployment and ensuring its efficient and uninterrupted availability. Regardless of an API's specific functionality, the overall workflow and patterns involved in building, testing, deploying, and securing a serverless, cloud-native Python application remain mostly the same, regardless of size.<p data-block-key=7ccce>Automation streamlines deployment by reducing errors and saving time. It allows for seamless updates and feature releases to keep the application up-to-date and adaptable to user needs.<p data-block-key=2dq1i>Continuous availability is crucial. Using Google Cloud Platform's fully managed serverless Cloud Run service for containers spin up as many containers as required without much work from our side. When there is no load, all containers are removed.<p data-block-key=8ke31>Securing a serverless, cloud-native Python application is critical. Google Cloud IAM (Identity and Access Management) service accounts can be used to manage access control and permissions. IAM provides granular control over resource access and actions, safeguarding sensitive data and preventing unauthorized access.<p data-block-key=3497m>By understanding and applying these principles and best practices, we can establish a strong foundation for building and maintaining successful serverless, cloud-native Python applications, regardless of their size. The core workflow and patterns provide a reliable framework for efficient deployment, continuous availability, and enhanced security.</div></div></div></div></div></div></div></div></div></div>